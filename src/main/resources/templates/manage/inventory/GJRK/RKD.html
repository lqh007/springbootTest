<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
    <title>新建加工入库单</title>
    <link rel="stylesheet" href="../../../../../../itsoftui/plugins/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../../../../../../itsoftui/plugins/icheck/icheck.css">
    <link rel="stylesheet" href="../../../../../../common/css/indexBase.css">
    <link rel="stylesheet" type="text/css" href="../../../../../../itsoftui/plugins/pikaday/pikaday.css" />
    <link rel="stylesheet" href="../../../../../../itsoftui/css/itsoftui.css">
    <style>
        .handle{
            color: #2e8ded;
            cursor: pointer;
        }
        .selectrow .handle{
            color: #fff;
        }
        .timeBtn span{
            margin-top: 0;
        }
        .table-search-menu{
            width: 865px!important;
        }
        .tip{
            color: #aa1111;
        }
    </style>
</head>
<body>
<div class="pd-10 wrap">
    <div class="wrap-top">
        <p style="color: #737373;float: left;">库存->入库验收单</p>
        <p id="closeBtn" style="float: right;"></p>
    </div>
    <div class="wrap-bd">
        <div class="itsoft-toolbar">
            <div id="toolBtn"></div>
            <div id="toolBtnRt" style="float: right"></div>
        </div>
        <div class="itsoft-panel">
            <div class="itsoft-panel-form" style="height: 150px">
                <form id="addform" class="form form-horizontal" action="ajaxOperation.ashx?Action=formUpload" method="post" enctype="multipart/form-data" style="width:720px">
                    <div class=" row form-group">
                        <label class=" col-md-1  control-label" style="width: 80px;">单据号：</label>
                        <div class="col-md-1 " style="width: 200px;">
                            <input type="text" name="gysname" placeholder="单据号自动生成" disabled="disabled" class="form-control">
                        </div>
                        <label class=" col-md-1  control-label" style="width: 90px;">备注：</label>
                        <div class="col-md-1 " style="width: 380px;">
                            <input type="text" name="bz" placeholder="备注信息" class="form-control">
                        </div>
                    </div>
                    <div class=" row form-group">
                        <label class=" col-md-1  control-label" style="width: 80px;">制单人：</label>
                        <div class="col-md-1 " style="width: 150px;">
                            <input type="text" name="bz" placeholder="备注信息" class="form-control">
                        </div>
                        <label class=" col-md-1  control-label" style="width: 80px;">制单时间：</label>
                        <div class="col-md-1 " style="width: 150px;">
                            <input type="text" name="bz" value="2018-03-07" class="form-control">
                        </div>
                        <label class="col-md-1 control-label" style="width: 90px;">入库日期：</label>
                        <div class="col-md-1" style="width: 200px;">
                            <input type="text" id="gyTime" name="gyTime" placeholder="请选择供应时间" class="form-control">
                            <i class="iconfont iconfont-arrow2-bottom" style=" float:right; position: absolute; top:2px;right:20px"></i>
                        </div>
                    </div>
                </form>
                <div id="orderlog" style="position: absolute; height: 145px; overflow: auto; right: 2px;
            line-height: 25px; top: 0px; width: 410px;">
                    <p style="margin-top: 5px;">
                        <code>温馨提示:</code></p>
                    <p>
                        1.录入物料时请先选择供应商,带*号为必填项目;</p>
                    <p>
                        2.入库验收后系统自动过账，单据锁定;</p>
                    <p>
                        3.入库时间可以推迟，但只能推迟一个账期；</p>
                    <p>
                        4.批次可以为生产日期也可以为批号，日期格式YYYY-MM-dd。</p>
                </div>
            </div>
            <div class="itsoft-datagrid" style="border-top: 0">
                <div id="datagrid"></div>
            </div>

        </div>
    </div>
</div>
</body>
<script src="../../../../../../itsoftui/plugins/jquery-1.12.4.js"></script>
<script src="../../../../../../itsoftui/plugins/layer/layer.js"></script>
<script src="../../../../../../itsoftui/plugins/moment.min.js" type="text/javascript"></script>
<script src="../../../../../../itsoftui/plugins/pikaday/pikaday.js" type="text/javascript"></script>
<script src="../../../../../../itsoftui/plugins/icheck/jquery.icheck.min.js"></script>
<script src="../../../../../../itsoftui/js/itsoftui.js"></script>
<script>
    var index=parent.layer.getFrameIndex(window.name);
    var datagrid;
    $(function () {

        //关闭按钮
        $('#closeBtn').toolbarbtn({
            btn:[
                {
                    text:'',
                    title:'关闭',
                    width:'35px',
                    icon:'iconfont-close',
                    click:function () {
                        parent.ITSOFT.itWin.close(index);
                    }
                }
            ]
        });
        //按钮
        $('#toolBtn').toolbarbtn({
            btn:[
                {
                 text:'删除单据',
                 title:'删除单据',
                 width:'100px',
                 icon:'iconfont-del2',
                 click:function () {
                     
                 }   
                },
                {
                 text:'计划导入',
                 title:'计划导入',
                 width:'100px',
                 icon:'iconfont-daoru',
                 click:function () {

                 }
                }
            ]
        });
        $('#toolBtnRt').toolbarbtn({
            btn:[
                {
                 text:'新单',
                 title:'新单',
                 icon:'iconfont-fabu',
                 click:function () {

                 }
                },
                {
                 text:'保存',
                 title:'保存',
                 icon:'iconfont-save',
                 click:function () {

                 }
                },
                {
                 text:'审核',
                 title:'审核',
                 icon:'iconfont-edit2',
                 click:function () {

                 }
                }
            ]
        });

        //供应商
        $('#wareHouse').dropdownlist({
            dataurl:'../../../../../../data/select.json',
            placeholder:'请选择供应商',
            width:'352px',
            'allowinput': true,
            changeEvent:function (val,text) {

            }
        });
        //直入直出
        $('#demandUnit').dropdownlist({
            dataurl:'../../../../../../data/select.json',
            placeholder:'请选择需求单位',
            width:'182px',
            changeEvent:function (val,text) {

            }
        });

        //供应时间
        var pickerydrq = new Pikaday({
            field: document.getElementById('gyTime'),
            firstDay: 1,
            format: 'YYYY-MM-DD',
            minDate: ITSOFT.tools.dateCalDay(1, 0), //today
            maxDate: ITSOFT.tools.dateCalDay(1, 30), //30days  后
            yearRange: [2010, 2020]
        });
       //列表
      datagrid = $('#datagrid').datagrid({
            keyField: "orderid",
            page:false,
            url: '../../../../../../data/order.json',
            type: 'GET',
            line: "both",
            isSequence: true,
            singleSelect: true,
            eventrow: false,
            click: function() {

            },
            dblclick: function() {

            },
            columns:[
                {
                    field:'id',
                    isshow:false
                },{
                    title: '<a title="添加行" class="iconfont listbtn addrow iconfont-add"></a>',
                    width: '30',
                    formatter: function(val, i) {
                        return '<a title="删除行" class="iconfont listbtn delrow iconfont-del"></a>';
                    }
                },{
                    title: '编码',
                    field: 'state',
                    align: "center",
                    width: '120',
                    formatter:function (val) {
                        return '<input type="text" value="" name="coding">'
                    }
                },
                {
                    title: '原料名称',
                    field: 'rawName',
                    align: "center",
                    width: '180',
                    overflow: "visible",
                    formatter:function () {
                        return '<input type="text" name="rawName" data=""  value="">' +
                               '<a class="iconfont listbtn iconfont-more"></a>' +
                               '<div class="table-search-menu"></div>';
                    }
                },
                {
                    title: '原料类别',
                    field: 'rawType',
                    align: "center",
                    width: '150',
                    formatter:function () {
                        return ''
                    }
                },
                {
                    title: '规格',
                    field: 'rawUnit',
                    align: "center",
                    width: '100',
                    formatter:function () {
                        return ''
                    }
                },
                {
                    title: '单位',
                    field: 'rawDw',
                    align: "center",
                    width: '80',
                    formatter:function () {
                        return ''
                    }
                },
                {
                    title: '品牌',
                    field: 'rawBrand',
                    align: "center",
                    width: '150',
                    formatter:function () {
                        return ''
                    }
                },
                {
                    title: '保质期',
                    field: 'rawBZQ',
                    align: "center",
                    width: '150',
                    formatter:function () {
                        return ''
                    }
                },
                {
                    title: '批次',
                    field: 'rawPC',
                    align: "center",
                    width: '150',
                    formatter:function () {
                        return '<input type="text" value=" ">'
                    }
                },
                {
                    title: '数量',
                    field: 'rawSL',
                    align: "center",
                    width: '100',
                    formatter:function () {
                        return '<input type="text" value=" ">'
                    }
                },
                {
                    title: '采购价',
                    field: 'rawSL',
                    align: "center",
                    width: '100',
                    formatter:function () {
                        return '<input type="text" value=" ">'
                    }
                },
                {
                    title: '金额',
                    field: 'rawJE',
                    align: "center",
                    width: '100',
                    formatter:function () {
                        return ''
                    }
                },
                {
                    title: '备注',
                    field: 'remark',
                    align: "left",
                    width: '100',
                    widthfix:true,
                    formatter:function () {
                        return '<input type="text" value=" ">'
                    }
                },
            ]
        });


        $('.btnop').on('click','span',function () {
            $(this).addClass('on').siblings().removeClass('on')
        });

        //点击添加行
        $("#datagrid").on("click", ".addrow", function(e) {
            addrow();
        });

        function  addrow() {

            datagrid.addRow(0, null, null);
            var row = $("#datgrid1 .table-body tr").last();
            $(row).find("input").eq(0).focus();
        }

        //编码input搜索
        $('#datagrid').on('keydown','input[name="coding"]',function (e) {
              var key=e.keyCode;
              var val=$(this).val();
              if(key==13){
                  var queryParams = {
                      "kfid": "0",
                      "findvalue": val
                  };
                  //查询数据
                  ITSOFT.dataAjax({
                      url: '../../../../../../data/material.json',
                      type: 'GET',
                      async: true,
                      data: queryParams,
                      beforeSend: function() {},
                      success: function(res) {
                          if (res.data.length > 0) {
                                  var col=res.data[0];
                                  var row=datagrid.getSelectedRow();
                                  //材料id
                                  row.children("td[field='mid']").text(col.id);
                                  //原料名称
                                  row.children("td[field='rawName']").children("input").val(col.name);
                                  //原料类别
                                  row.children("td[field='rawType']").text(col.spec);
                                  //规格
                                  row.children("td[field='rawUnit']").text(col.unit);
                                  //单位
                                  row.children("td[field='rawDw']").text(col.unit);
                                  //品牌
                                  row.children("td[field='rawBrand']").text(col.unit);
                                  //保质期
                                  row.children("td[field='rawBZQ']").text(col.price);
                                  //金额
                                  row.children("td[field='rawJE']").text(col.price);
                                  row.attr("ischange", "1")
                          }
                      },
                      complete: function() {

                      },
                      error: function() {
                          ITSOFT.tools.showMsg("error", "数据加载失败")
                      }
                  });
              }
        });


       var  _time;
        //原料名称查询
        $('#datagrid').on('keydown','input[name="rawName"]',function () {
            var obj = $(this);
            var menu = obj.nextAll(".table-search-menu");
            clearTimeout(_time);
            _time = setTimeout(function() {
                loadSearchData(menu, obj.val().trim());
            }, 300);
        });
        
        function loadSearchData(menu,val) {
            $(menu).empty();
            var $loading = $("<div class='loading'>加载中...</div>");
            $(menu).append($loading)
            if (menu.is(":hidden")) {
                $(document).find(".table-search-menu").hide();
                    menu.show();
            };
            var queryParams = {
                "kfid": "0",
                "findvalue": val
            };
            //查询数据
            ITSOFT.dataAjax({
                url: '../../../../../../data/material.json',
                type: 'GET',
                async: true,
                data: queryParams,
                beforeSend: function() {},
                success: function(res) {
                    if (res.data.length > 0) {
                        $.each(res.data, function(i, row) {
                            var $table = $("<ul class='table-search'/>");
                            //id
                            $table.append('<li  field="rawId"  style="display:none">' + row["id"] + '</li>')
                            //原料名称
                            $table.append('<li field="rawName" style="width:178px; text-align:left;"  >' + row["name"] + '</li>')
                            //原料类别
                            $table.append('<li field="rawType" style="width:150px"  >' + row["barcode"] + '</li>')
                            //规格
                            $table.append('<li field="rawUnit"  style="width:100px"  >' + row["spec"] + '</li>')
                            //单位
                            $table.append('<li field="rawDw" style="width:80px"  >' + row["unit"] + '</li>')
                            //品牌
                            $table.append('<li field="rawBrand" style="width:150px"  >' + row["manufacturers"] + '</li>')
                            //保质期
                            $table.append('<li field="rawBZQ" style="width:100px"  >' + row["price"] + '</li>')
                            //金额
                            $table.append('<li field="rawJE" style="width:100px"  >' + row["price"] + '</li>')
                            menu.append($table);
                        });
                    }
                },
                complete: function() {
                    $(menu).find(".loading").remove();
                },
                error: function() {
                    ITSOFT.tools.showMsg("error", "数据加载失败")
                }
            });
            $(document).on("click", ".table-search-menu ul", function(e) {
                $(this).siblings().removeClass('currentrow').end().addClass('currentrow');
                var curmenurow = menu.find(".currentrow");
                if (curmenurow.length == 0) return false;
                var cols = '[{';
                curmenurow.find("li").each(function() {
                    cols += '"' + $(this).attr("field") + '":"' + $(this).text().trim() + '",';
                });
                cols += '"itsfot":""}]';
                editrow(datagrid.getSelectedRow(), JSON.parse(cols));
                menu.hide();
            });
            function editrow(row, data) {
                console.log(data)
                $.each(data, function(i, col) {
                    //材料id
                    row.children("td[field='mid']").text(col["id"]);
                    //原料名称
                    row.children("td[field='rawName']").children("input").val(col.rawName);
                    //原料类别
                    row.children("td[field='rawType']").text(col.rawType);
                    //规格
                    row.children("td[field='rawUnit']").text(col.rawUnit);
                    //单位
                    row.children("td[field='rawDw']").text(col.rawDw);
                    //品牌
                    row.children("td[field='rawBrand']").text(col.rawBrand);
                    //保质期
                    row.children("td[field='rawBZQ']").text(col.rawBZQ);
                    //金额
                    row.children("td[field='rawJE']").text(col.rawJE);
                    row.attr("ischange", "1")
                });

            }

        };
        //更多
        $('#datagrid').on('click','.iconfont-more',function () {
            ITSOFT.itWin.open({
                title:'选择原料[1，打钩选中原料 2，点确定进行添加 3，可以多选]',
                area:['900px','500px'],
                content:['addRow.html','no']
            })
        });
    });
    function insertrow(data) {
        var currentrow = datagrid.getSelectedRow(); //当前行
        $.each(data, function(i, col) {
            if (i == 0) {
                //材料id
                currentrow.children("td[field='mid']").text(col["mid"]);
                //材料名称
                currentrow.children("td[field='mname']").children("input").val(col["mname"]);
                //这句话目的为了验证输入的值和选中的值
                currentrow.children("td[field='mname']").children("input").attr("data", col["mname"]);
                //材料国际码
                currentrow.children("td[field='mbarcode']").text(col["mbarcode"]);
                //材料规格
                currentrow.children("td[field='mspec']").text(col["mspec"]);
                //材料单位
                currentrow.children("td[field='munit']").text(col["munit"]);
                //材料厂家
                currentrow.children("td[field='mmanufacturers']").text(col["mmanufacturers"]);
                currentrow.attr("ischange", "1")
            } else {
                var newdata = {
                    'orderid': '0'
                }; //orderid 合并进去
                $.extend(true, col, newdata);
                currentrow = datagrid.addRow(0, null, col,currentrow);
                currentrow.attr("ischange", "1");
            }

        });

    }




</script>
</html>