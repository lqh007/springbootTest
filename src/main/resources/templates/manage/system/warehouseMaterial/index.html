<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
    <title>库房原料设置</title>
    <link rel="stylesheet" href="../../../../static/itsoftui/plugins/bootstrap/css/bootstrap.css" th:href="@{${root}+'/itsoftui/plugins/bootstrap/css/bootstrap.css'}">
    <link rel="stylesheet" href="../../../../static/itsoftui/plugins/bootstrap-3.3.5-dist/daterangepicker-bs3.css"  th:href="@{${root}+'/itsoftui/plugins/bootstrap-3.3.5-dist/daterangepicker-bs3.css'}"/>
    <link rel="stylesheet" href="../../../../static/itsoftui/plugins/icheck/icheck.css" th:href="@{${root}+'/itsoftui/plugins/icheck/icheck.css'}">
    <link rel="stylesheet" href="../../../../static/common/css/indexBase.css" th:href="@{${root}+'/common/css/indexBase.css'}">
    <link rel="stylesheet" href="../../../../static/itsoftui/css/itsoftui.css" th:href="@{${root}+'/itsoftui/css/itsoftui.css'}">
    <style>
        .main_Lt{
            width: 230px;
            float: left;
            height: 100%;
        }
        .main_Rt{
            margin-left: 235px;
        }
        .dropdownlist{
            border:1px solid #ccc;
            float: left;
            margin-top: 5px;
        }
        .handle{
            color: #2e8ded;
            cursor: pointer;
        }
        .selectrow .handle{
            color: #fff;
        }
        .SdInput .icheckbox-blue{
            margin-top: -16px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
 <div class="pd-10 wrap">
    <div class="wrap-top">
        <p style="color: #737373;float: left;">系统管理->库房原料设置</p>
        <p id="closeBtn" style="float: right;"></p>
    </div>
    <div class="wrap-bd">
        <div class="itsoft-panel">
            <div class="main_Lt">
                <div class="itsoft-toolbar">
                    <span style="font-size: 16px;color: #333;float: left;line-height: 44px">库房：</span>
                    <div class="dropdownlist" id="wareHouseSelect" name="wareHouseSelect"></div>
                </div>
                <div class="itsoft-datagrid" style="border-top: 0">
                    <div id="dataTree"></div>
                </div>
            </div>
            <div class="main_Rt">
                <div class="itsoft-toolbar" style="border-top: 0">
                    <div id="toolBtn"></div>
                    <div id="toolSearch" style="float: right"></div>
                </div>
                <div class="itsoft-datagrid" style="border-top: 0">
                    <div id="datagrid"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="../../../../static/itsoftui/plugins/jquery-1.12.4.js" th:src="@{${root}+'/itsoftui/plugins/jquery-1.12.4.js'}"></script>
<script src="../../../../static/itsoftui/plugins/layer/layer.js" th:src="@{${root}+'/itsoftui/plugins/layer/layer.js'}"></script>
<script src="../../../../static/itsoftui/plugins/icheck/jquery.icheck.min.js" th:src="@{${root}+'/itsoftui/plugins/icheck/jquery.icheck.min.js'}"></script>
<script src="../../../../static/itsoftui/plugins/moment.min.js" th:src="@{${root}+'/itsoftui/plugins/moment.min.js'}" type ="text/javascript"></script>
<script src="../../../../static/itsoftui/plugins/bootstrap-3.3.5-dist/daterangepicker.js" th:src="@{${root}+'/itsoftui/plugins/bootstrap-3.3.5-dist/daterangepicker.js'}" type="text/javascript"></script>
<script src="../../../../static/itsoftui/plugins/bootstrap-3.3.5-dist/date.js" th:src="@{${root}+'/itsoftui/plugins/bootstrap-3.3.5-dist/date.js'}" type ="text/javascript"></script>
<script src="../../../../static/itsoftui/js/itsoftui.js" th:src="@{${root}+'/itsoftui/js/itsoftui.js'}"></script>
<script>
    var datagrid,dataTree;
    var typeName = '';
    var index=parent.layer.getFrameIndex(window.name);
    var dataList = [];
    var idList = [];
    var loadingindex;
    var exportdata = "";//选择列
    var url = "";//导出地址
    var search = '';
    var warehouseId = '';
    var materialTypeId = '';
    $(function () {
        //关闭按钮
        $('#closeBtn').toolbarbtn({
            btn:[
                {
                    text:'',
                    title:'关闭',
                    width:'35px',
                    icon:'iconfont-close',
                    click:function () {
                        parent.ITSOFT.itWin.close(index);
                    }
                }
            ]
        });
        //库房下拉
        var warehouseSel = $('#wareHouseSelect').dropdownlist({
            type:'post',
            dataurl:'[[${root}]]//api/v2/dining/manage/diningWarehouse/diningWarehouseRolesSelect',
            // placeholder:'请选择库房',
            width:'160px',
            autoLoad:true,
            changeEvent:function (val,text) {
                if (typeName != val) {
                    typeName = val;
                    var queryParams = {};
                    queryParams.warehouseId = val;
                    datagrid.refreshData(queryParams);
                    warehouseId = val;
                }
            }
        });
        warehouseId = warehouseSel.getValueText().value;
        var warehouseSelLi = $('#wareHouseSelect').find('.ddbody').find('.dropdownul').find('li');
        if (warehouseSelLi.length == 0){
            var ul = '<ul class="dropdownul"><li text="" value="" class="selectedrow" style="color: red;">您当前没有库房权限</li></ul>';
            $('#wareHouseSelect').find('.ddbody').html(ul);
            $('#wareHouseSelecttext').val('您当前没有库房权限').css('color','red').attr('placeholder','您当前没有库房权限');
        }else{
            if (warehouseSelLi.length > 1){
                var newli = '<li text="全部" value="all">全部</li>';
                var li = $('#wareHouseSelect').find('.ddbody').find('.dropdownul').html();
                newli += li;
                $('#wareHouseSelect').find('.ddbody').find('.dropdownul').html(newli);
            }
        }




        dataTree= $('#dataTree').itsofttree({
            url:'[[${root}]]/api/v2/dining/manage/diningMaterialType/diningMaterialTypeTreeList',
            type: "post",
            root: ['root','所有类型'], //根节点 如['root','根节点']
            click:function (val,text) {
                if (typeName != val) {
                    typeName = val;
                    var queryParams = {};
                    queryParams.materialTypeId = val;
                    datagrid.refreshData(queryParams);
                    materialTypeId = val;
                }
            }
        });

        //搜索
        $('#toolSearch').toolbarsearch({
            width:'160px',
            placeholder:'编码/名称',
            searchEvent:function (val) {
                var queryParams = {searchValue:val};
                datagrid.refreshData(queryParams)
                search = val;
            }
        });
        //操作按钮
        $('#toolBtn').toolbarbtn({
            btn:[
                {
                    text:'刷新',
                    title:'刷新',
                    icon:"iconfont-huanyipi",
                    click:function () {
                        datagrid.refreshData();
                    }
                },
                {
                    text:'添加',
                    title:'添加',
                    icon:"iconfont-add",
                    click:function () {
                        addNewPage()
                    }
                },
                {
                    text:'保存',
                    title:'保存',
                    icon:"iconfont-save",
                    click:function () {
                        saveChangesData();
                    }
                },
                {
                    text:'设置供应商',
                    title:'设置供应商',
                    icon:"iconfont-root",
                    width:'100px',
                    click:function () {
                        addSupplier()
                    }
                },
                {
                    text:'导出',
                    title:'导出',
                    icon:"iconfont-daochu",
                    click:function () {
                        exportWin()
                    }
                },
                {
                    text:'删除',
                    title:'删除',
                    icon:"iconfont-del2",
                    click:function () {
                        delData();
                    }
                }
            ]
        });
        datagrid = $('#datagrid').datagrid({
            keyField: "id",
            page:true,
            url: '[[${root}]]/api/v2/dining/manage/diningWarehouseMaterial/diningWarehouseMaterialList',
            type: 'post',
            line: "both",
            isSequence: true,
            queryParams:{warehouseId:warehouseSel.getValueText().value},
            singleSelect: false,
            eventrow: false,
            click: function() {

            },
            dblclick: function() {
                loadPage()
            },
            columns:[
                {
                    field:'id',
                    isshow:false
                },{
                    title: '编码',
                    field: 'materialNumber',
                    align: "center",
                    width: '80',
                    formatter:function () {
                    }
                },
                {
                    title: '名称',
                    field: 'materialName',
                    align: "left",
                    width: '140',
                    formatter:function () {
                    }
                },
                {
                    title: '类别',
                    field: 'typeName',
                    align: "center",
                    width: '100',
                    formatter:function () {
                    }
                },
                {
                    title: '规格',
                    field: 'specification',
                    align: "center",
                    width: '100',
                    formatter:function () {
                    }
                },
                {
                    title: '采购价',
                    field: 'purchasePrice',
                    align: "center",
                    width: '100',
                    formatter:function () {
                    }
                },
                {
                    title: '锁定采购价',
                    field: 'lockPurchasePrice',
                    align: "center",
                    width: '100',
                    formatter:function (v,i,r) {
                        var html = '<div class="check-box" style="margin-left: 30px;margin-top: 5px">';
                            html += '<input type="checkbox" id="checkbox-1" name="lockPurchasePrice"';
                            if (v == 1){
                                html += 'checked="checked"';
                            }
                            html += '>';
                            html += '<label for="checkbox-1"></label>';
                            html += '</div>';
                        return html
                    }
                },
                {
                    title: '供应价',
                    field: 'supplyPrice',
                    align: "center",
                    width: '100',
                    formatter:function () {

                    }
                },
                {
                    title: '锁定供应价',
                    field: 'lockSupplyPrice',
                    align: "center",
                    width: '100',
                    formatter:function (v,i,r) {
                        var html = '<div class="check-box" style="margin-left: 30px;margin-top: 5px">';
                            html += '<input type="checkbox" id="checkbox-2" name="lockSupplyPrice"';
                            if (v == 1){
                                html += 'checked="checked"';
                            }
                            html += '>';
                            html += '<label for="checkbox-2"></label>';
                            html += '</div>';
                        return html
                    }
                },
                {
                    title: '计划价',
                    field: 'markUp',
                    align: "center",
                    width: '80',
                    formatter:function (v,i,r) {
                        return '<input type="text" class="form-control" value="'+v+'" name="markUp">'
                    }
                },
                {
                    title: '库存上限',
                    field: 'maxInventory',
                    align: "center",
                    width: '80',
                    formatter:function (v,i,r) {
                        return '<input type="text" class="form-control" value="'+v+'" name="maxInventory">'
                    }
                },
                {
                    title: '库存下限',
                    field: 'minInventory',
                    align: "center",
                    width: '80',
                    formatter:function (v,i,r) {
                        return '<input type="text" class="form-control" value="'+v+'" name="minInventory">'
                    }
                },
                {
                    title: '供应商',
                    field: 'supplierNum',
                    align: "center",
                    width: '100',
                    formatter:function (v,i,r) {
                        var id = r.id;
                        return '<span class="supplierDetail" style="cursor: pointer;" data-id="'+id+'" title="查看供应商">('+v+')</span>';
                    }
                },
                {
                    title: '条码',
                    field: 'barCode',
                    align: "center",
                    width: '100',
                    formatter:function () {
                    }
                },
                {
                    title: '单位',
                    field: 'unit',
                    align: "center",
                    width: '100',
                    formatter:function () {
                    }
                },
                {
                    title: '品牌',
                    field: 'brand',
                    align: "center",
                    width: '100',
                    formatter:function () {
                    }
                },
                {
                    title: '保质期',
                    field: 'warranty',
                    align: "center",
                    width: '100',
                    formatter:function () {
                    }
                },
                {
                    title: '编辑人',
                    field: 'updateUser',
                    align: "center",
                    width: '100',
                    formatter:function () {
                    }
                },
                {
                    title: '编辑时间',
                    field: 'updateTimeValue',
                    align: "center",
                    width: '140',
                    formatter:function () {
                    }
                }
            ]
        });
        datagrid.loadData(0);

        //添加库房原料
        function addNewPage() {
            var warehouseId = warehouseSel.getValueText().value;
            if (warehouseId.length == 0){
                ITSOFT.tools.showMsg("error", "请选择库房");
                return false;
            }
            ITSOFT.itWin.open({
                title:'添加原料',
                area:['850px','450px'],
                content:['[[${root}]]/redirect/system/addWarehouseMaterial?warehouseId='+warehouseId,'no']
            })
        }

        //添加供应商
        function addSupplier() {
            console.log(idList);
            var selectedRow = datagrid.getSelectedRow();
            var selectedRows = datagrid.getSelectedRows();
            var id = datagrid.getColumn(selectedRow,'id')
            if (id.length == 0 && selectedRows.length == 0){
                ITSOFT.tools.showMsg("error", "请选择原料");
                return false;
            }
            dataList.push(id);
            idList = dataList;
            if (selectedRows.length > 0){
                idList = selectedRows;
            }
            ITSOFT.itWin.open({
                title:'设置供应商',
                area:['850px','450px'],
                content:['[[${root}]]/redirect/system/addWarehouseMaterialSupplier?type=add','no']
            })
            dataList = [];
        }

        //删除库房原料
        function delData() {
            var selectedRows = datagrid.getSelectedRows();
            if (selectedRows.length == 0){
                ITSOFT.tools.showMsg("error", "请选择要删除的原料");
                return false;
            }
            var msgtxt = "确定要删除";
            if(selectedRows.length > 1) {
                msgtxt += "[选择的" + selectedRows.length + "条数据]吗？";
            } else {
                //提示字段要修改
                msgtxt += "[" + datagrid.getColumnText(selectedRows[0], "materialName") + "]吗？";
            }
            ITSOFT.itWin.confirm(msgtxt, function() {
                //在这里执行相关操作,可以批量传递key数组，也可以遍历分别操作
                ITSOFT.dataAjax({
                    url: '[[${root}]]/api/v2/dining/manage/diningWarehouseMaterial/deleteWarehouseMaterial',
                    type: 'post',
                    data: {ids:selectedRows},
                    async: false,
                    beforeSend: function () {
                        loadingindex = ITSOFT.itWin.msg("正在提交数据",16);
                    },
                    success: function (data) {
                        ITSOFT.itWin.close(loadingindex);
                        if (data.errorCode == 0) {
                            ITSOFT.tools.showMsg("ok", "已删除");
                            $(selectedRows).each(function(i,val) {
                                //执行成功后删除datagrid数据
                                datagrid.deleteRow(val);
                            });
                        } else {
                            ITSOFT.tools.showMsg("error", data.message);
                            return false;
                        }
                    },
                    error: function () {
                        ITSOFT.itWin.close(loadingindex);
                        ITSOFT.tools.showMsg("error", data.message);
                    },
                    complete: function () {
                        ITSOFT.itWin.close(loadingindex);
                    }
                });
            });
        };

        $('#datagrid').on('click','.supplierDetail',function () {
            var id = $(this).attr('data-id');
            ITSOFT.itWin.open({
                title:'查看供应商',
                area:['850px','450px'],
                content:['[[${root}]]/redirect/system/warehouseMaterialSupplierDetails?id='+id,'no']
            })
        })

        $('#datagrid').on('click','input[type=checkbox]',function () {
            $(this).parents('tr').attr("isChange",'1');
        })

        $('#datagrid').on('change','input[type=text]',function () {
            $(this).parents('tr').attr("isChange",'1');
        })
        
        function saveChangesData() {
            var rows = $('#datagrid').find('.datagrid-body').find('.table-body').find('tr[isChange=1]');
            if (rows.length == 0){
                ITSOFT.tools.showMsg("error", "未修改任何数据!");
                return false;
            }
            var changesData = '[';
            $('#datagrid').find('.datagrid-body').find('.table-body').find('tr[isChange=1]').each(function (i,o) {
                if (i == 0){
                    changesData += '{'
                }else{
                    changesData += ',{'
                }

                var id = $(o).attr('keyvalue');
                var materialName = $(o).find('td[field=lockPurchasePrice]').text();
                var lockPurchasePrice = '0';
                if ($(o).find('td[field=lockPurchasePrice]').find('input[name=lockPurchasePrice]').is(':checked')){
                    lockPurchasePrice = '1';
                }
                var lockSupplyPrice = '0';
                if ($(o).find('td[field=lockSupplyPrice]').find('input[name=lockSupplyPrice]').is(':checked')){
                    lockSupplyPrice = '1';
                }
                var markUp = $(o).find('td[field=markUp]').find('input[name=markUp]').val();
                if (isNaN(parseFloat(markUp)) || parseFloat(markUp) < 0) {
                    ITSOFT.tools.showMsg("error", materialName+"的计划价输入有误！");
                    return false;
                }
                var maxInventory = $(o).find('td[field=maxInventory]').find('input[name=maxInventory]').val();
                if (isNaN(parseFloat(maxInventory)) || parseFloat(maxInventory) < 0) {
                    ITSOFT.tools.showMsg("error", materialName+"的库存上限输入有误！");
                    return false;
                }
                var minInventory = $(o).find('td[field=minInventory]').find('input[name=minInventory]').val();
                if (isNaN(parseFloat(minInventory)) || parseFloat(minInventory) < 0) {
                    ITSOFT.tools.showMsg("error", materialName+"的库存下限输入有误！");
                    return false;
                }

                changesData += '"id":"' + id + '",';
                changesData += '"lockPurchasePrice":"' + lockPurchasePrice + '",';
                changesData += '"lockSupplyPrice":"' + lockSupplyPrice + '",';
                changesData += '"markUp":"' + markUp + '",';
                changesData += '"maxInventory":"' + maxInventory + '",';
                changesData += '"minInventory":"' + minInventory + '"}';
            })
            changesData += ']'
            ITSOFT.dataAjax({
                url: '[[${root}]]/api/v2/dining/manage/diningWarehouseMaterial/saveWarehouseMaterialChangesData',
                type: 'post',
                data: {changesDataStr:changesData},
                async: false,
                beforeSend: function () {
                    loadingindex = ITSOFT.itWin.msg("正在提交数据",16);
                },
                success: function (data) {
                    ITSOFT.itWin.close(loadingindex);
                    if (data.errorCode == 0) {
                        ITSOFT.tools.showMsg("ok", data.message);
                    } else {
                        ITSOFT.tools.showMsg("error", data.message);
                        return false;
                    }
                },
                error: function () {
                    ITSOFT.itWin.close(loadingindex);
                    ITSOFT.tools.showMsg("error", data.message);
                },
                complete: function () {
                    ITSOFT.itWin.close(loadingindex);
                }
            });
            
        }
        //导出
        $('#datagrid').find('.datagrid-header').find('.header-rows').find('td').each(function (i) {
            var field=$(this).attr('field');
            var value=$(this).text();
            if(i>2){
                exportdata+=field+","+value+";";
            }
        })

        function exportWin() {
            ITSOFT.itWin.open({
                area:['350px','500px'],
                closeBtn:1,
                content:['[[${root}]]/api/v2/dining/excelUtils/chooseFieldsExport','no']
            })
        }
    });
    //导出
    function exportData(data,index) {
        ITSOFT.itWin.close(index);
        url = '[[${root}]]/api/v2/dining/excelUtils/diningWarehouseMaterialExport?search='+search+'&warehouseId='+warehouseId+'&materialTypeId='+materialTypeId+'&fields='+data;
        top.window.location=encodeURI(url);
    }
</script>
</html>